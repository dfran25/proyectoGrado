{% extends "base.html" %}
{% block title %}Paso 8: Posible Solucion del Caso - Sistema Juridico{% endblock %}

{% block extra_css %}
<style>
  :root {
    --brand-orange: #f97316;
    --brand-purple: #7c3aed;
  }
  
  .wizard-header {
    background: linear-gradient(135deg, var(--brand-orange) 0%, var(--brand-purple) 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 10px 10px 0 0;
  }
  
  .progress-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--brand-orange), var(--brand-purple));
    width: 88.88%; /* 8/9 pasos */
    transition: width 0.3s ease;
  }
  
  .form-section {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .section-title {
    color: var(--brand-purple);
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
  }
  
  .solution-textarea {
    min-height: 200px;
    resize: vertical;
  }
  
  .conciliation-section {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
    border: 1px solid rgba(40, 167, 69, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
  }
  
  .intention-cards {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .intention-card {
    flex: 1;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .intention-card:hover {
    border-color: var(--brand-purple);
    background-color: rgba(124, 58, 237, 0.05);
  }
  
  .intention-card.selected {
    border-color: var(--brand-purple);
    background-color: rgba(124, 58, 237, 0.1);
  }
  
  .intention-icon {
    font-size: 2.5rem;
    color: var(--brand-purple);
    margin-bottom: 0.5rem;
  }
  
  .student-section {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 8px;
    padding: 1.5rem;
  }
  
  .commitment-section {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
    border: 1px solid rgba(220, 53, 69, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--brand-orange) 0%, #ea580c 100%);
    border: none;
    padding: 12px 30px;
    font-weight: 600;
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #ea580c 0%, var(--brand-orange) 100%);
    transform: translateY(-1px);
  }
  
  .form-control:focus {
    border-color: var(--brand-purple);
    box-shadow: 0 0 0 0.2rem rgba(124, 58, 237, 0.25);
  }
  
  .required-field::after {
    content: " *";
    color: #dc3545;
  }
  
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }
  
  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .slider {
    background-color: var(--brand-purple);
  }
  
  input:checked + .slider:before {
    transform: translateX(26px);
  }
  
  .character-counter {
    font-size: 0.875rem;
    color: #6c757d;
  }
  
  .character-counter.valid {
    color: #28a745;
  }
  
  .character-counter.warning {
    color: #ffc107;
  }
  
  @media (max-width: 768px) {
    .intention-cards {
      flex-direction: column;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      
      <!-- Header del Wizard -->
      <div class="card shadow-sm mb-4">
        <div class="wizard-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1">Nueva Denuncia Juridica</h4>
              <p class="mb-0">Paso 8 de 9: Posible Solucion del Caso</p>
            </div>
            <div class="text-end">
              <small>Progreso</small>
              <div class="progress-bar mt-1" style="width: 200px;">
                <div class="progress-fill"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <form method="post" id="paso8Form">
            {% csrf_token %}
            
            <!-- Solución Propuesta -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-lightbulb me-2"></i>
                Posible Solucion al Caso
              </h5>
              
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="form-label required-field mb-0">
                    Describa la solucion que considera mas apropiada para su caso
                  </label>
                  <button type="button" class="btn btn-sm btn-outline-info" id="btnAsistenteIA" title="Obtener sugerencias de artículos legales">
                    <i class="bi bi-robot me-1"></i> Asistente Legal IA
                  </button>
                </div>
                <textarea name="solucion_propuesta" class="form-control solution-textarea"
                          placeholder="Explique detalladamente que solucion espera obtener, que acciones considera que deberian tomarse, y cual seria el resultado ideal para resolver su situacion..."
                          required></textarea>
                <div class="d-flex justify-content-between align-items-center mt-1">
                  <small class="text-muted">
                    Sea especifico sobre lo que espera lograr con la asesoria juridica
                  </small>
                  <small class="character-counter">
                    <span id="solucionCounter">0</span>/100 caracteres mínimo
                    <i class="bi bi-check-circle text-success ms-1" id="solucionCheck" style="display: none;"></i>
                  </small>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label">Fecha limite para entregar el documento</label>
                  <input type="date" name="fecha_limite_entrega" class="form-control"
                         min="{{ today }}">
                  <small class="text-muted">Si tiene una fecha limite especifica</small>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">Urgencia del caso</label>
                  <select name="urgencia" class="form-select">
                    <option value="">Seleccione...</option>
                    <option value="BAJA">Baja - No hay urgencia</option>
                    <option value="MEDIA">Media - Moderadamente urgente</option>
                    <option value="ALTA">Alta - Muy urgente</option>
                    <option value="CRITICA">Critica - Extremadamente urgente</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Conciliación -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-peace me-2"></i>
                Conciliacion y MASC
              </h5>
              
              <div class="conciliation-section">
                <div class="row">
                  <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <div>
                        <h6 class="mb-1">Es susceptible de conciliacion?</h6>
                        <small class="text-muted">¿Su caso puede resolverse mediante dialogo?</small>
                      </div>
                      <label class="toggle-switch">
                        <input type="checkbox" name="susceptible_conciliacion" id="susceptibleConciliacion">
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <div>
                        <h6 class="mb-1">Se diligencio solicitud de conciliacion?</h6>
                        <small class="text-muted">¿Ya inicio un proceso de conciliacion?</small>
                      </div>
                      <label class="toggle-switch">
                        <input type="checkbox" name="solicitud_conciliacion_diligenciada" id="solicitudConciliacion">
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3">
                  <label class="form-label">Observaciones sobre conciliacion</label>
                  <textarea name="observaciones_conciliacion" class="form-control" rows="3"
                            placeholder="Si aplica, proporcione detalles sobre intentos de conciliacion previos o posibilidades futuras..."></textarea>
                </div>
              </div>
            </div>

            <!-- Intención del Usuario -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-bullseye me-2"></i>
                Intencion del Usuario
              </h5>
              
              <p class="text-muted mb-3">Seleccione cual es su principal intencion al solicitar esta asesoria:</p>
              
              <div class="intention-cards">
                <div class="intention-card" data-value="conciliar">
                  <input type="radio" name="intencion_usuario" value="conciliar" id="conciliar" hidden>
                  <i class="bi bi-handshake intention-icon"></i>
                  <h6>Conciliar</h6>
                  <p class="small text-muted mb-0">Buscar un acuerdo o dialogo con la contraparte</p>
                </div>
                
                <div class="intention-card" data-value="procedibilidad">
                  <input type="radio" name="intencion_usuario" value="procedibilidad" id="procedibilidad" hidden>
                  <i class="bi bi-file-text intention-icon"></i>
                  <h6>Cumplir requisito</h6>
                  <p class="small text-muted mb-0">Cumplir requisito de procedibilidad legal</p>
                </div>
                
                <div class="intention-card" data-value="dialogar">
                  <input type="radio" name="intencion_usuario" value="dialogar" id="dialogar" hidden>
                  <i class="bi bi-chat-dots intention-icon"></i>
                  <h6>Dialogar</h6>
                  <p class="small text-muted mb-0">Dialogar con ayuda de un tercero</p>
                </div>
              </div>
            </div>

            <!-- Autorización de Email -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-envelope me-2"></i>
                Autorizacion de Envio
              </h5>
              
              <div class="mb-3">
                <label class="form-label">Correo electronico autorizado para envio del documento</label>
                <input type="email" name="email_autorizacion" class="form-control" 
                       placeholder="correo@ejemplo.com">
                <small class="text-muted">
                  Indique el correo donde desea recibir el documento resultado de la asesoria
                </small>
              </div>
            </div>

            <!-- Información del Estudiante -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-mortarboard me-2"></i>
                Informacion del Estudiante
              </h5>
              
              <div class="student-section">
                <p class="fw-semibold mb-3">Esta seccion sera completada por el estudiante que atiende la asesoria:</p>
                
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label">Nombre completo del estudiante</label>
                    <input type="text" name="estudiante_nombre" class="form-control" 
                           placeholder="Sera completado por el estudiante">
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label">Codigo IDUNAB del estudiante</label>
                    <input type="text" name="estudiante_codigo" class="form-control" 
                           placeholder="Sera completado por el estudiante">
                  </div>
                </div>
              </div>
            </div>

            <!-- Documentos Pendientes -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-clock me-2"></i>
                Documentos e Informacion Pendiente
              </h5>
              
              <div class="commitment-section">
                <div class="alert alert-warning mb-3">
                  <h6><i class="bi bi-exclamation-triangle me-2"></i>Compromiso del Usuario</h6>
                  <p class="mb-0">
                    <strong>Me comprometo de forma expresa</strong> a suministrar en el termino de ocho (8) dias habiles 
                    la informacion y documentos adicionales requeridos para adelantar el tramite pertinente. 
                    En caso de <u>NO</u> hacerlo, mi comportamiento se entendera por el Consultorio Juridico 
                    como un <u>DESISTIMIENTO TACITO</u> del servicio solicitado.
                  </p>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Relacion de documentos e informacion pendiente</label>
                  <textarea name="documentos_pendientes" class="form-control" rows="4"
                            placeholder="Liste los documentos o informacion adicional que debe proporcionar posteriormente..."></textarea>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label">Plazo maximo de entrega de documentos pendientes</label>
                    <input type="date" name="fecha_limite_documentos" class="form-control"
                           min="{{ today }}">
                  </div>
                  
                  <div class="col-md-6">
                    <div class="form-check mt-4">
                      <input class="form-check-input" type="checkbox" name="acepta_compromiso" id="aceptaCompromiso" required>
                      <label class="form-check-label" for="aceptaCompromiso">
                        <strong>Acepto el compromiso descrito arriba</strong>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Observaciones Finales -->
            <div class="form-section">
              <h5 class="section-title">
                <i class="bi bi-chat-square-text me-2"></i>
                Observaciones Finales
              </h5>
              
              <div class="mb-3">
                <label class="form-label">Observaciones adicionales sobre el caso</label>
                <textarea name="observaciones_finales" class="form-control" rows="4"
                          placeholder="Cualquier informacion adicional que considere relevante para la asesoria..."></textarea>
                <div class="text-end mt-1">
                  <small class="character-counter">
                    <span id="observacionesCounter">0</span> caracteres
                  </small>
                </div>
              </div>
            </div>

            <!-- Botones de navegación -->
            <div class="d-flex justify-content-between mt-4">
              <a href="{% url 'denuncias:wizard_paso' paso='paso7' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Paso Anterior
              </a>
              
              <button type="submit" class="btn btn-primary">
                Continuar al Resumen
                <i class="bi bi-arrow-right ms-2"></i>
              </button>
            </div>
            
          </form>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Modal Asistente Legal IA -->
<div class="modal fade" id="modalAsistenteIA" tabindex="-1" aria-labelledby="modalAsistenteIALabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="modalAsistenteIALabel">
          <i class="bi bi-robot me-2"></i>Asistente Legal IA
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Loading state -->
        <div id="iaLoading" class="text-center py-5">
          <div class="spinner-border text-info mb-3" role="status">
            <span class="visually-hidden">Analizando...</span>
          </div>
          <p class="text-muted">Analizando los hechos de su caso...</p>
          <small class="text-muted">Esto puede tomar unos segundos</small>
        </div>

        <!-- Results -->
        <div id="iaResultados" style="display: none;">
          <!-- Análisis -->
          <div class="mb-4">
            <h6 class="text-info"><i class="bi bi-search me-2"></i>Análisis del Caso</h6>
            <p id="iaAnalisis" class="bg-light p-3 rounded"></p>
          </div>

          <!-- Artículos sugeridos -->
          <div class="mb-4">
            <h6 class="text-info"><i class="bi bi-book me-2"></i>Artículos Legales Relevantes</h6>
            <div id="iaArticulos" class="list-group">
              <!-- Se llenará dinámicamente -->
            </div>
          </div>

          <!-- Recomendaciones -->
          <div>
            <h6 class="text-info"><i class="bi bi-lightbulb me-2"></i>Recomendaciones</h6>
            <ul id="iaRecomendaciones" class="list-group list-group-flush">
              <!-- Se llenará dinámicamente -->
            </ul>
          </div>
        </div>

        <!-- Error state -->
        <div id="iaError" style="display: none;">
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="iaErrorMsg"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">
          <i class="bi bi-info-circle me-1"></i>
          Esta es una sugerencia automatizada. Consulte siempre con un profesional.
        </small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('paso8Form');
    const submitBtn = form.querySelector('button[type="submit"]');
    const intentionCards = form.querySelectorAll('.intention-card');
    
    // Manejar selección de intención
    intentionCards.forEach(function(card) {
        card.addEventListener('click', function() {
            // Remover selección previa
            intentionCards.forEach(function(c) {
                c.classList.remove('selected');
            });
            
            // Seleccionar actual
            this.classList.add('selected');
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
        });
    });
    
    // Validación del formulario
    form.addEventListener('submit', function(e) {
        const solucionPropuesta = form.querySelector('[name="solucion_propuesta"]').value;
        const aceptaCompromiso = form.querySelector('#aceptaCompromiso').checked;
        
        if (solucionPropuesta.length < 100) {
            e.preventDefault();
            alert('Por favor proporcione una descripcion mas detallada de la solucion propuesta (minimo 100 caracteres)');
            return;
        }
        
        if (!aceptaCompromiso) {
            e.preventDefault();
            alert('Debe aceptar el compromiso para continuar');
            return;
        }
        
        // Loading state
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
        submitBtn.disabled = true;
    });
    
    // Auto-resize textarea
    const solutionTextarea = form.querySelector('[name="solucion_propuesta"]');
    const observacionesTextarea = form.querySelector('[name="observaciones_finales"]');
    const solucionCounter = document.getElementById('solucionCounter');
    const solucionCheck = document.getElementById('solucionCheck');
    const observacionesCounter = document.getElementById('observacionesCounter');
    
    // Contador de caracteres para solución propuesta
    solutionTextarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
        
        const length = this.value.length;
        solucionCounter.textContent = length;
        
        const counterElement = solucionCounter.parentElement;
        
        if (length >= 100) {
            counterElement.classList.add('valid');
            counterElement.classList.remove('warning');
            solucionCheck.style.display = 'inline';
        } else if (length >= 50) {
            counterElement.classList.add('warning');
            counterElement.classList.remove('valid');
            solucionCheck.style.display = 'none';
        } else {
            counterElement.classList.remove('valid', 'warning');
            solucionCheck.style.display = 'none';
        }
    });
    
    // Contador de caracteres para observaciones
    observacionesTextarea.addEventListener('input', function() {
        const length = this.value.length;
        observacionesCounter.textContent = length;
    });
    
    // Inicializar contadores
    solutionTextarea.dispatchEvent(new Event('input'));
    observacionesTextarea.dispatchEvent(new Event('input'));

    // Botón de IA - Funcionalidad completa
    const btnIA = document.getElementById('btnAsistenteIA');
    if (btnIA) {
        btnIA.addEventListener('click', async function() {
            // Obtener los hechos del caso (del paso 6, almacenado en localStorage o desde el servidor)
            const solucionTexto = document.querySelector('[name="solucion_propuesta"]').value;

            // Intentar obtener los hechos guardados
            let hechos = '';
            const savedData = localStorage.getItem('wizard_paso6_temp');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    hechos = data.descripcion_hechos || '';
                } catch (e) {
                    console.log('No se encontraron hechos guardados');
                }
            }

            // Si no hay hechos, pedir al usuario que los describa
            if (!hechos) {
                hechos = prompt('Por favor, describa brevemente los hechos de su caso para obtener sugerencias legales:');
                if (!hechos) {
                    return;
                }
            }

            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalAsistenteIA'));
            modal.show();

            // Mostrar loading
            document.getElementById('iaLoading').style.display = 'block';
            document.getElementById('iaResultados').style.display = 'none';
            document.getElementById('iaError').style.display = 'none';

            try {
                const response = await fetch("{% url 'denuncias:asistente_legal_ia' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        hechos: hechos,
                        area_juridica: '{{ caso.get_consultation_area_display|default:"No especificada" }}'
                    })
                });

                const result = await response.json();

                document.getElementById('iaLoading').style.display = 'none';

                if (result.error) {
                    document.getElementById('iaError').style.display = 'block';
                    document.getElementById('iaErrorMsg').textContent = result.error;
                    return;
                }

                // Mostrar resultados
                const data = result.data;
                document.getElementById('iaResultados').style.display = 'block';

                // Análisis
                document.getElementById('iaAnalisis').textContent = data.analisis || 'Sin análisis disponible';

                // Artículos
                const articulosContainer = document.getElementById('iaArticulos');
                articulosContainer.innerHTML = '';
                if (data.articulos && data.articulos.length > 0) {
                    data.articulos.forEach(art => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${art.codigo} - Art. ${art.articulo}</h6>
                                    <p class="mb-0 small text-muted">${art.descripcion}</p>
                                </div>
                            </div>
                        `;
                        articulosContainer.appendChild(item);
                    });
                } else {
                    articulosContainer.innerHTML = '<p class="text-muted">No se encontraron artículos específicos</p>';
                }

                // Recomendaciones
                const recomendacionesContainer = document.getElementById('iaRecomendaciones');
                recomendacionesContainer.innerHTML = '';
                if (data.recomendaciones && data.recomendaciones.length > 0) {
                    data.recomendaciones.forEach(rec => {
                        const item = document.createElement('li');
                        item.className = 'list-group-item';
                        item.innerHTML = `<i class="bi bi-check2 text-success me-2"></i>${rec}`;
                        recomendacionesContainer.appendChild(item);
                    });
                } else {
                    recomendacionesContainer.innerHTML = '<li class="list-group-item text-muted">Sin recomendaciones adicionales</li>';
                }

            } catch (error) {
                document.getElementById('iaLoading').style.display = 'none';
                document.getElementById('iaError').style.display = 'block';
                document.getElementById('iaErrorMsg').textContent = 'Error de conexión. Por favor intente nuevamente.';
                console.error('Error:', error);
            }
        });
    }
});
</script>
{% endblock %}